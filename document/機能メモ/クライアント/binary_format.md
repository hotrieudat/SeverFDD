# 暗号化ファイル仕様について
## 概要
FileKeyにおいての「暗号化ファイル」は２種類存在する
* サーバーより復号パスワードを入手し、復号するタイプのもの(以下基本暗号化ファイル)
* ファイルそのものより復号パスワードを入手し、オフライン状態でも復号ができるタイプのもの(以下オフライン暗号化ファイル)


また、FileKeyにおいて、ファイル暗号化の基本的な要件は以下のとおりである。

* ファイルの内容が読み取れないよう暗号化されていること
* FileKeyによって暗号化されていること

さらに以下の要件を付け加えた

* ファイル形式のバージョンがわかること

また、「オフライン暗号化ファイル」では以下の要件が加わる

* ファイル復号化のためのパスワードが、**復号が許可されたユーザーでなければ復号化できないような形で暗号化され**、  
格納されていること

## 基本暗号化ファイル
基本的なバイナリ形式は以下のとおりである

<img src="./binary_format/normal.svg" height="400px">

* 固定文字列
    先頭16バイトは、このファイルがFileKeyで暗号化されたことを示す文字列である  
    その文字列は、バイト列で  
    「'0x50 0x4c 0x4f 0x54 0x54 0x46 0x49 0x4c 0x45 0x4b 0x45 0x59 0x20 0x76 0x65 0x72'」とする  
    (PLOTTFILEKEY verという文字列のASCIIコードである)
* 契約者識別ID
    「このファイルはどの契約者のFileKeyで暗号化されたか」を識別するための文字列である
    A社で暗号化されたものとB社で暗号化されたものは区別されなければならない
    TODO:具体的なフォーマット
* バージョン
    バージョンアップに伴い、暗号化形式が変化した時のためのものである  
    そんなものはないが、1byte のunsingned int型
* タイプ
    暗号化ファイルのタイプを表す  
    現状は「基本暗号化ファイル」と「オフライン暗号化ファイル」の２種類である  
    TODO: タイプを実際にどう表すのか考える  
    ex.) 0b00000000が「基本暗号化ファイル」、 0b00000001が「オフライン暗号化ファイル」など
* Salt
    パスワードより初期ベクトル、共通鍵を生成する際に使用する
* 暗号化ファイルデータ
    暗号化されたファイルの実データ 暗号化方法については後述

## オフライン暗号化ファイル

<img src="./binary_format/offline.svg" height="500px">

* 固定文字列
* 契約者識別ID
* バージョン
* タイプ  
* Salt
    ここまでは基本暗号化ファイルと全く同様

* 暗号化されたパスワードエリアのバイト数
    後述の「暗号化されたパスワード群」の長さである  
    「暗号化されたパスワード群」はその性質上長さが不定となるので、ここで長さを指定しておく必要がある
    unsigned long int型 ビッグエンディアン

* 暗号化されたパスワード群
    同ファイルをデコードするためのパスワードである  
    許可されたユーザーの公開鍵で暗号化するものとする  
    したがって、許可されたユーザー分だけの暗号化パスワードが格納される
    パスワードはさらにbase64エンコードし、区切り文字に,(カンマ)を使うものとする
    base64でエンコードする理由は、区切り文字を設定しづらいからである

    なお、暗号化されたパスワードの長さは不定、許可されたユーザーの数も不定であることから、  
    このエリアのサイズは不定である

* 暗号化ファイルデータ
    同上

## 暗号化ファイルデータについて
TODO:これから書く
