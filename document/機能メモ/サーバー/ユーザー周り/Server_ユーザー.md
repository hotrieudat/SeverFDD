# ユーザー周りの仕様書（仮）

## 要件定義の内容

* 暗号化ができるユーザーとできないユーザーが分けられるようにする
* LDAPとの連携ができる
* LDAPにて連携時に
* ユーザー情報をインポートできる機能を用意する
* 公開鍵認証で実装する
* PW強度について変更ができる → 将来的な実装
* PWのリマインダー機能


=========================================================
=========================================================


# DBカラム構成

## ユーザー情報を管理するマスタのカラム情報について
* ユーザーID
* ログインID
* パスワード
* ユーザー名
* ユーザーフリガナ
* メールアドレス
* ユーザーの公開鍵
* 暗号化設定
* LDAP用ID
* パスワード変更日時
* 暗号可否
* 暗号化ファイル閲覧権限
* 暗号可否の編集権限
* ログの閲覧範囲
*


>
> 登録者・更新者・登録日・更新日に関しては、下記URLを参照
>
> [PlottGenerator リンク](https://192.168.12.200/admin/)
>
> ID/PW plott/plott
>
> ※カラム情報はリンクより確認してください

## LDAP情報を管理するマスタについて

* 別途要検討 → SF6をベースにすれば行けるかも？

=================================================
=================================================

#機能概要

### 新規登録・編集・削除・検索・CSV出力に関してはプロットフレームワークの仕様に従う

### 別途作成が必要な機能について
* [公開鍵認証機能](#anchor1)
* [ユーザー情報のインポート機能](#anchor2)
* [PW強度によるバリデーション](#anchor3)
* [PWのリマインダー機能](#anchor4)
* [クライアント側で作成された公開鍵をサーバー側に登録する機能](#anchor5)


<a id="anchor1"></a>

### <a href="#anchor1">公開鍵認証機能</a>

* 概要
    * クライアントアプリからサーバーに対して認証を行う際に使用
    * パスワード認証でも良いが、鍵ペアはオフライン暗号化で必要となるためこちらにも転用

* 認証手順
    1. クライアント、サーバーにログイン依頼（その際セッション作成）
      2. User/createOneTimePasswor に[user_id : xxxxx]という形式でユーザーIDを渡す
    2.  サーバー、ワンタイムパスワードを生成、セッションに保存する 同時に、ユーザーの公開鍵で暗号化してクライアントに返す
    3.  クライアント、自らの秘密鍵で復号化してその値をサーバーに返す
    4.  サーバー、セッションに保存したワンタイムパスワードとクライアントからの値が同一であれば、クライアントを認証する
      5. User/authenticateOneTimePassword に[one_time_password : xxxxxxxxxxx]を渡す

<a id="anchor2"></a>

### <a href="#anchor2">ユーザー情報のインポート機能</a>

* 概要
    * ユーザー情報をTSVにて一括で取り込む機能（ファイルの形式については用相談）
        > CSVだと考慮しなくてはならない点が多くめんどくさいのでやだ
    * 既に登録済みのログインIDがTSVに含まれていた場合は、登録を失敗とする
    * 取り込む情報については、1000件を上限とする （要相談）

<a id="anchor3"></a>

### <a href="#anchor3">PW強度によるバリデーション</a>

* 概要
    * 別途ヴァリデーション機能を要する必要あり

<a id="anchor4"></a>

### <a href="#anchor4">PWのリマインダー機能</a>

* 概要
    * 基本的に、SmoothFile6の挙動に合わせる。以下該当システムの仕様
      1. パスワードリセット画面にて、ログインIDを入力
      2. 入力されたログインIDに紐づく、メールアドレスに再発行用のURLを配布する
      3. 再発行用URLに記載されたページにアクセスすると新たに設定されたパスワードがメールで送られる
      4. メールに記載されたパスワードでログインを実施する。
        - ※会社の設定にて、パスワードの有効期限設定を使用する設定だと、ログイン時にユーザー自身でパスワードを再設定する画面に遷移する。

    * LDAPユーザーは利用不可
    > メールアドレスが登録されていない場合どうするのか ⇒ メールアドレスを必須にする？


<a id="anchor5"></a>

### <a href="#anchor5">クライアント側で作成された公開鍵をサーバー側に登録する機能</a>

* 概要
    * クライアント側で登録された、秘密鍵のペアとなる公開鍵を登録されているユーザー情報に更新する機能
    * 処理概要
        1. クライアントより、アカウントID、ログインID、パスワード、公開鍵を受け取る
        1. 受け取った情報をもとに登録済みのアカウントが存在するか判定
        1. 存在したら、受け取った公開鍵を登録する
    * __JsonデータをHttpsで受け取るために、php.iniのallow_url_fopenを変更する必要がある[参考記事](http://helog.jp/xampp/file_get_contents-https/)__
